<!-- ========= modal1.html (Проект 2) ========= -->

<!-- Стили локального модуля -->
<style>
  /* Контейнер модуля */
  #modal1-container {
    font-family: 'Comfortaa', sans-serif;
    width: 100%;
    max-width: 1920px;
    margin: 0 auto;
  }
  /* Верхняя часть модального окна */
  #modal1-container .modal-top {
    width: 100%;
    max-width: 1920px;
    margin: 0 auto;
    height: 330px;
    background-color: #f5f5f5;
    border-radius: 12px;
    border: 1px solid rgba(0, 0, 0, 0.10);
    box-shadow: 6px 6px 16px rgba(22,20,19,0.4);
    padding: 20px;
    overflow: hidden;
    z-index: 1100;
  }
  /* Нижняя часть модального окна */
  #modal1-container .modal-bottom {
    width: 100%;
    max-width: 1920px;
    margin: 0 auto;
    height: calc(100vh - 395px);
    background-color: #f5f5f5;
    border-radius: 12px;
    border: 1px solid rgba(0, 0, 0, 0.10);
    box-shadow: 6px 6px 16px rgba(22,20,19,0.4);
    padding: 20px;
    overflow-x: hidden;
    overflow-y: auto;
    z-index: 1100;
  }
  /* Общий стиль для строк блока */
  #modal1-container .modalRow {
    display: flex;
    position: relative;
    flex-direction: row;
    background: none;
    gap: 10px;
  }
  #modal1-container .modalColumn {
    display: flex;
    position: relative;
    flex-direction: column;
    background: none;
    gap: 10px;
  }
  /* Контейнер для отображения заказов */
  #modal1-container .modalVNUT-content {
    padding: 0 20px 0 0;
    height: 100%;
    width: 100%;
    overflow-y: scroll;
    box-sizing: border-box;
  }
  /* Стилизация скроллбара */
  #modal1-container .modalVNUT-content::-webkit-scrollbar {
    width: 4px;
    background-color: #e2e2e2;
    border-radius: 20px;
  }
  #modal1-container .modalVNUT-content::-webkit-scrollbar-thumb {
    background-color: #212121;
    border-radius: 20px;
  }
  #modal1-container .modalVNUT-content::-webkit-scrollbar-track {
    background-color: #e2e2e2;
  }
  /* Блок-контейнер (форма ввода заказа) */
  #modal1-container .modalBLOCK {
    gap: 14px;
    display: flex;
    position: relative;
    padding: 10px;
    height: auto;
    color: black;
    z-index: 1100;
    box-sizing: border-box;
    vertical-align: middle;
    background: none;
    backdrop-filter: blur(0px);
    -webkit-backdrop-filter: blur(0px);
    border-radius: 10px;
    margin-top: -10px;
  }
  #modal1-container .modalBLOCK:hover,
  #modal1-container .modalBLOCK:focus {
    background: rgba(255, 255, 255, 0.05);
  }
  /* Стили для input полей */
  #modal1-container .inputT,
  #modal1-container .input,
  #modal1-container .inputSUM {
    padding: 7px;
    border-radius: 8px;
    font-size: 12px;
    font-weight: 500;
    border: 1px solid #E5E7E9;
    outline: none;
    transition: all 1s cubic-bezier(0.19, 1, 0.22, 1);
    box-shadow: 0px 0px 20px -18px;
    background: #f5f5f5;
    font-variant-numeric: tabular-nums;
  }
  #modal1-container .inputT {
    width: 250px;
    text-transform: uppercase;
  }
  #modal1-container .input {
    width: 250px;
  }
  #modal1-container .inputSUM {
    width: 116px;
    text-align: right;
  }
  #modal1-container .inputT:active,
  #modal1-container .input:active,
  #modal1-container .inputSUM:active {
    transform: scale(0.95);
  }
  #modal1-container .inputT:focus,
  #modal1-container .input:focus,
  #modal1-container .inputSUM:focus {
    border: 1px solid #1a1a1a;
  }
  /* Иконка (URL) */
  #modal1-container .spec-icon {
    color: #212121;
    font-size: 20px;
    cursor: pointer;
    display: flex;
    align-items: center;
    position: relative;
  }
  #modal1-container .spec-icon:hover {
    color: #625a56;
    transform: scale(1.1);
  }
  #modal1-container .spec-icon:active {
    transform: scale(0.92);
  }
  /* Чекбокс */
  #modal1-container .input[type="checkbox"] {
    display: none;
  }
  #modal1-container .custom-checkbox {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 2px solid #333;
    border-radius: 4px;
    position: relative;
    cursor: pointer;
  }
  #modal1-container .custom-checkbox::after {
    content: "";
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 10px;
    height: 10px;
    background-color: #333;
    border-radius: 2px;
    opacity: 0;
  }
  #modal1-container .input[type="checkbox"]:checked + .custom-checkbox::after {
    opacity: 1;
  }
  /* Кнопки */
  #modal1-container .button-form {
    position: relative;
    width: 200px;
    height: 40px;
    padding: 12px;
    background-color: #212121;
    border: 1px solid #212121;
    color: #f5f5f5;
    font-size: 14px;
    font-weight: 600;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.4s;
  }
  #modal1-container .button-form:hover {
    color: #212121;
    background-color: #f5f5f5;
  }
  /* Статистика (три прямоугольника вверху) */
  #modal1-container .stats {
    display: inline-grid;
    background-color: transparent;
    color: #212121;
    border-radius: 12px;
    border: none;
  }
  #modal1-container .stat {
    display: inline-grid;
    width: 500px;
    grid-template-columns: repeat(1, 1fr);
    column-gap: 10px;
    padding: 20px;
  }
  #modal1-container .stat-title {
    grid-column-start: 1;
    white-space: nowrap;
    color: #212121;
    font-size: 14px;
    text-transform: uppercase;
    font-weight: 800;
  }
  #modal1-container .stat-value {
    grid-column-start: 1;
    white-space: nowrap;
    font-size: 30px;
    line-height: 16px;
    font-weight: 700;
    margin-top: 18px;
  }
</style>

<!-- Основная разметка modal1 -->
<div id="modal1-container">
  <!-- Верхняя часть модального окна -->
  <div class="modal-top">
    <div class="modalRow">
      <div class="stats shadow">
        <div class="stat">
          <div class="stat-title">размещено заказов</div>
          <div class="stat-value">1 235 652</div>
        </div>
      </div>
      <div class="stats shadow">
        <div class="stat">
          <div class="stat-title">предоплачено</div>
          <div class="stat-value">356 201</div>
        </div>
      </div>
      <div class="stats shadow">
        <div class="stat">
          <div class="stat-title">оплата отложена</div>
          <div class="stat-value">850 100</div>
        </div>
      </div>
    </div>
    
    <div class="modalRow" style="top: 90px; margin-left: 1400px;">
      <button class="button-form" style="width: 230px; left: 5px;" id="move-warehouse">
        переместить на склад
      </button>
      <button class="button-form" style="width: 230px; left: 15px;" id="delete-selected">
        удалить выбранное
      </button>
    </div>
    
    <div class="modalRow" style="top: 102px;">
      <div class="modalBLOCK" style="margin-left: 26px; margin-top: -4px;">
        <div class="modalRow">
          <input class="inputT" style="width: 130px;" placeholder="RIV-0881"/>
          <input class="input"  style="width: 340px;" placeholder="наименование позиции"/>
          <input class="inputT" style="width: 213px;" placeholder="URL"/>
          <input class="inputT" style="width: 270px;" placeholder="поставщик"/>
          <input class="input"  style="width: 90px; margin-left: 32px;" placeholder="изм."/>
          <input class="inputSUM" style="width: 86px;" placeholder="000 000"/>
          <input class="inputSUM" placeholder="000 000 000"/>
        </div>
      </div>
      <button class="button-form" style="width: 330px; left: 163px;" id="create-order">
        создать позицию заказа
      </button>
    </div>
  </div>
  <!-- Нижняя часть модального окна -->
  <div class="modal-bottom" style="margin-top: 24px;">
    <div class="modalVNUT-content">
      <!-- Здесь будут отображаться блоки заказов, добавленные пользователем -->
    </div>
  </div>
</div>

<!-- Скрипт (type="module") с инициализацией Supabase и функцией initModal1() -->
<script type="module">
  // Инициализация Supabase (предполагаем, что window.supabase уже инициализирован)
  const supabase = window.supabase;
  const USER_KEY = window.USER_KEY;

  // Если загружаем напрямую (без динамики), сразу вызовем initModal1()
  initModal1();

  // Если загружаем динамически через fetch + innerHTML — 
  // то браузер при вставке <script> не выполняет его сам.
  // Ваш код (в родительском index.html) должен после вставки вызвать initModal1().
  // Или можно убрать строку "initModal1();" выше и всегда звать вручную.

  function initModal1() {
    console.log('[modal1.html] Модуль PAGE 1 активирован!');

     /*---------- 1. Загружаем все существующие заказы ----------*/
    loadExistingOrders();
    
    /*---------- 2. Сохранение нового заказа ----------*/
    // Функция записи заказа (таблица "orders")
    async function insertOrderToDB(orderData) {
      const { data, error } = await supabase
        .from('orders')
        .insert([orderData]);
      if (error) {
        throw error;
      }
      return data;
    }

    //загрузка уже существующих заказов
    async function loadExistingOrders() {
    const ordersContainer = document.querySelector(
      '#modal1-container .modal-bottom .modalVNUT-content'
    );

    // получаем все строки, сортируем по дате создания
    const { data: orders, error } = await supabase
      .from('orders')
      .select('*')
      .eq('user_key', USER_KEY)
      .order('created_at', { ascending: true });

    if (error) {
      console.error(error);
      return;
    }

    if (!orders || !orders.length) return;

    // генерируем HTML
    orders.forEach(order => {
      ordersContainer.insertAdjacentHTML(
        'beforeend',
        createOrderElement(order)
      );

      // привязываем иконку URL
      if (order.url) {
        const icon = ordersContainer.lastElementChild.querySelector('.spec-icon');
        icon.addEventListener('click', () => window.open(order.url, '_blank'));
      }
    });

    /*------ обновляем счётчики в «статистике» ------*/
    const totalCounter = document.querySelector(
      '#modal1-container .stats .stat-value'
    );                                                          // //счётчик заказов
    if (totalCounter) totalCounter.textContent = orders.length.toLocaleString();
  }

    // Генерация HTML для заказа
    function createOrderElement(orderData) {
      return `
      <div class="modalBLOCK">
        <label>
          <input type="checkbox" class="input">
          <span class="custom-checkbox" style="margin-top: 5.4px; margin-left: -8px;"></span>
        </label>
        <div class="modalRow">
          <input class="inputT" style="width: 130px;" placeholder="RIV-0881" value="${orderData.orderCode || ''}" readonly/>
          <input class="input"  style="width: 340px;" placeholder="наименование позиции" value="${orderData.name || ''}" readonly/>
          <input class="input"  style="width: 150px;" placeholder="статус" value="заказано" readonly/>
          <span class="spec-icon" style="margin-left: 30px;" data-url="${orderData.url || ''}">
            <i class="material-symbols-outlined">captive_portal</i>
          </span>
          <input class="inputT" style="width: 270px;" placeholder="поставщик" value="${orderData.supplier || ''}" readonly/>
          <input class="input"  style="width: 90px; margin-left: 30px;" placeholder="изм." value="${orderData.modification || ''}" readonly/>
          <input class="inputSUM" style="width: 86px;" placeholder="000 000" value="${orderData.field1 || ''}" readonly/>
          <input class="inputSUM" placeholder="000 000 000" value="${orderData.field2 || ''}" readonly/>
        </div>
        <div class="modalRow" style="margin-left: 30px;">
          <input class="input"  style="width: 90px;" placeholder="изм." readonly/>
          <input class="inputSUM" style="width: 86px;" placeholder="000 000" readonly/>
          <input class="inputSUM" placeholder="000 000 000" readonly/>
          <input class="inputSUM" placeholder="000 000 000" readonly/>
        </div>
      </div>
      `;
    }

    // Очистка формы (верхний блок)
    function clearForm() {
      const formBlock = document.querySelector('#modal1-container .modal-top .modalBLOCK');
      if (formBlock) {
        const inputs = formBlock.querySelectorAll('.modalRow input');
        inputs.forEach(input => {
          input.value = '';
        });
      }
    }

    // Логика кнопки "создать позицию заказа"
    const createOrderBtn = document.getElementById('create-order');
    if (createOrderBtn) {
      createOrderBtn.addEventListener('click', async function() {
        const formBlock = document.querySelector('#modal1-container .modal-top .modalBLOCK');
        if (!formBlock) return;

        const inputs = formBlock.querySelectorAll('.modalRow input');
        const orderData = {
          user_key:     USER_KEY,
          orderCode:    inputs[0].value.trim(),
          name:         inputs[1].value.trim(),
          url:          inputs[2].value.trim(),
          supplier:     inputs[3].value.trim(),
          modification: inputs[4].value.trim(),
          field1:       inputs[5].value.trim(),
          field2:       inputs[6].value.trim(),
          status:      "заказано"
        };

        if (!orderData.orderCode || !orderData.name) {
          alert("Пожалуйста, заполните обязательные поля (код и наименование).");
          return;
        }

        try {
          // Запись в бд
          await insertOrderToDB(orderData);
          // Создаём HTML
          const newHTML = createOrderElement(orderData);
          // Добавляем в контейнер
          const ordersContainer = document.querySelector('#modal1-container .modal-bottom .modalVNUT-content');
          if (ordersContainer) {
            ordersContainer.insertAdjacentHTML('beforeend', newHTML);
          }
          // Очищаем форму
          clearForm();

          // Привязываем к иконке URL
          const newIcon = ordersContainer.querySelector(`.spec-icon[data-url="${orderData.url}"]`);
          if (newIcon && orderData.url) {
            newIcon.addEventListener('click', () => {
              window.open(orderData.url, '_blank');
            });
          }

        } catch (error) {
          alert("Ошибка при создании заказа: " + error.message);
          console.error(error);
        }
      });
    }

    // Дополнительные кнопки
    const moveWarehouseBtn = document.getElementById('move-warehouse');
    if (moveWarehouseBtn) {
      moveWarehouseBtn.addEventListener('click', () => {
        console.log('Запущена логика перемещения на склад');
      });
    }
    const deleteSelectedBtn = document.getElementById('delete-selected');
    if (deleteSelectedBtn) {
      deleteSelectedBtn.addEventListener('click', () => {
        console.log('Запущена логика удаления выбранного');
      });
    }
  }
</script>
