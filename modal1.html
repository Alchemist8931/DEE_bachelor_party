<!-- ========= modal1.html (Проект 2) ========= -->

<!-- Стили локального модуля -->
<style>
  /* Контейнер модуля */
  #modal1-container {
    font-family: 'Comfortaa', sans-serif;
    width: 100%;
    max-width: 1920px;
    margin: 0 auto;
  }
  /* Верхняя часть модального окна */
  #modal1-container .modal-top {
    width: 100%;
    max-width: 1920px;
    margin: 0 auto;
    height: 330px;
    background-color: #f5f5f5;
    border-radius: 12px;
    border: 1px solid rgba(0, 0, 0, 0.10);
    box-shadow: 6px 6px 16px rgba(22,20,19,0.4);
    padding: 20px;
    overflow: hidden;
    z-index: 1100;
  }
  /* Нижняя часть модального окна */
  #modal1-container .modal-bottom {
    width: 100%;
    max-width: 1920px;
    margin: 0 auto;
    height: calc(100vh - 395px);
    background-color: #f5f5f5;
    border-radius: 12px;
    border: 1px solid rgba(0, 0, 0, 0.10);
    box-shadow: 6px 6px 16px rgba(22,20,19,0.4);
    padding: 20px;
    overflow-x: hidden;
    overflow-y: auto;
    z-index: 1100;
  }
  /* Общий стиль для строк блока */
  #modal1-container .modalRow {
    display: flex;
    position: relative;
    flex-direction: row;
    background: none;
    gap: 10px;
  }
  #modal1-container .modalColumn {
    display: flex;
    position: relative;
    flex-direction: column;
    background: none;
    gap: 10px;
  }
  /* Контейнер для отображения заказов */
  #modal1-container .modalVNUT-content {
    padding: 0 20px 0 0;
    height: 100%;
    width: 100%;
    overflow-y: scroll;
    box-sizing: border-box;
  }
  /* Стилизация скроллбара */
  #modal1-container .modalVNUT-content::-webkit-scrollbar {
    width: 4px;
    background-color: #e2e2e2;
    border-radius: 20px;
  }
  #modal1-container .modalVNUT-content::-webkit-scrollbar-thumb {
    background-color: #212121;
    border-radius: 20px;
  }
  #modal1-container .modalVNUT-content::-webkit-scrollbar-track {
    background-color: #e2e2e2;
  }
  /* Блок-контейнер (форма ввода заказа) */
  #modal1-container .modalBLOCK {
    gap: 14px;
    display: flex;
    position: relative;
    padding: 10px;
    height: auto;
    color: black;
    z-index: 1100;
    box-sizing: border-box;
    vertical-align: middle;
    background: none;
    backdrop-filter: blur(0px);
    -webkit-backdrop-filter: blur(0px);
    border-radius: 10px;
    margin-top: -10px;
  }
  #modal1-container .modalBLOCK:hover,
  #modal1-container .modalBLOCK:focus {
    background: rgba(255, 255, 255, 0.05);
  }
  /* Стили для input полей */
  #modal1-container .inputT,
  #modal1-container .input,
  #modal1-container .inputSUM {
    padding: 7px;
    border-radius: 8px;
    font-size: 12px;
    font-weight: 500;
    border: 1px solid #E5E7E9;
    outline: none;
    transition: all 1s cubic-bezier(0.19, 1, 0.22, 1);
    box-shadow: 0px 0px 20px -18px;
    background: #f5f5f5;
    font-variant-numeric: tabular-nums;
  }
  #modal1-container .inputT {
    width: 250px;
    text-transform: uppercase;
  }
  #modal1-container .input {
    width: 250px;
  }
  #modal1-container .inputSUM {
    width: 116px;
    text-align: right;
  }
  #modal1-container .inputT:active,
  #modal1-container .input:active,
  #modal1-container .inputSUM:active {
    transform: scale(0.95);
  }
  #modal1-container .inputT:focus,
  #modal1-container .input:focus,
  #modal1-container .inputSUM:focus {
    border: 1px solid #1a1a1a;
  }

  /* ---- кастомный select ---- */
#global-select-dropdown{
  position:fixed;               /* за пределами всех модальных блоков */
  max-height: 160px; width: 160px;
  background: #f5f5f5; border: 1px solid #E5E7E9;
  border-radius: 8px; box-shadow: 0 4px 16px rgba(22,20,19,.25);
  overflow-y:auto; opacity:0; visibility: hidden;
  transform:translateY(-10px);  transition:.25s;
  z-index:9999;
  margin-top: 6px;
}
#global-select-dropdown.show{ opacity:1; visibility:visible; transform:translateY(0); }
#global-select-dropdown::-webkit-scrollbar{
  width:4px; background:#e2e2e2; border-radius:20px;
}
#global-select-dropdown::-webkit-scrollbar-thumb{
  background:#212121; border-radius:20px;
}
#global-select-dropdown .select-option{
  padding:6px 10px; font-size:12px; cursor:pointer;
}
#global-select-dropdown .select-option:hover{ background:rgba(0,0,0,.05); }

/* лёгкий затемнённый фон, чтобы закрывать по клику */
#select-overlay{
  position:fixed; inset:0; background:transparent;
  z-index:9998; display:none;
}

  
  /* Иконка (URL) */
  #modal1-container .spec-icon {
    color: #212121;
    font-size: 20px;
    cursor: pointer;
    display: flex;
    align-items: center;
    position: relative;
  }
  #modal1-container .spec-icon:hover {
    color: #625a56;
    transform: scale(1.1);
  }
  #modal1-container .spec-icon:active {
    transform: scale(0.92);
  }
  /* Чекбокс */
  #modal1-container .input[type="checkbox"] {
    display: none;
  }
  #modal1-container .custom-checkbox {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 2px solid #333;
    border-radius: 4px;
    position: relative;
    cursor: pointer;
  }
  #modal1-container .custom-checkbox::after {
    content: "";
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 10px;
    height: 10px;
    background-color: #333;
    border-radius: 2px;
    opacity: 0;
  }
  #modal1-container .input[type="checkbox"]:checked + .custom-checkbox::after {
    opacity: 1;
  }
  /* Кнопки */
  #modal1-container .button-form {
    position: relative;
    width: 200px;
    height: 40px;
    padding: 12px;
    background-color: #212121;
    border: 1px solid #212121;
    color: #f5f5f5;
    font-size: 14px;
    font-weight: 600;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.4s;
  }
  #modal1-container .button-form:hover {
    color: #212121;
    background-color: #f5f5f5;
  }
  /* Статистика (три прямоугольника вверху) */
  #modal1-container .stats {
    display: inline-grid;
    background-color: transparent;
    color: #212121;
    border-radius: 12px;
    border: none;
  }
  #modal1-container .stat {
    display: inline-grid;
    width: 500px;
    grid-template-columns: repeat(1, 1fr);
    column-gap: 10px;
    padding: 20px;
  }
  #modal1-container .stat-title {
    grid-column-start: 1;
    white-space: nowrap;
    color: #212121;
    font-size: 14px;
    text-transform: uppercase;
    font-weight: 800;
  }
  #modal1-container .stat-value {
    grid-column-start: 1;
    white-space: nowrap;
    font-size: 30px;
    line-height: 16px;
    font-weight: 700;
    margin-top: 18px;
  }
</style>

<!-- Основная разметка modal1 -->
<div id="modal1-container">

<!-- ——— портальный контейнер для выпадающего списка ——— -->
<div id="select-overlay"></div>
<div id="global-select-dropdown"></div>
  
  <!-- Верхняя часть модального окна -->
  <div class="modal-top">
    <div class="modalRow">
      <div class="stats shadow">
        <div class="stat">
          <div class="stat-title">размещено заказов</div>
          <div class="stat-value">1 235 652</div>
        </div>
      </div>
      <div class="stats shadow">
        <div class="stat">
          <div class="stat-title">предоплачено</div>
          <div class="stat-value">356 201</div>
        </div>
      </div>
      <div class="stats shadow">
        <div class="stat">
          <div class="stat-title">оплата отложена</div>
          <div class="stat-value">850 100</div>
        </div>
      </div>
    </div>
    
    <div class="modalRow" style="top: 90px; margin-left: 1400px;">
      <button class="button-form" style="width: 230px; left: 5px;" id="move-warehouse">
        переместить на склад
      </button>
      <button class="button-form" style="width: 230px; left: 15px;" id="delete-selected">
        удалить выбранное
      </button>
    </div>
    
    <div class="modalRow" style="top: 102px;">
      <div class="modalBLOCK" style="margin-left: 26px; margin-top: -4px;">
        <div class="modalRow">
          <input class="inputT" style="width: 130px;" placeholder="RIV-0881"/>
          <input class="input"  style="width: 340px;" placeholder="наименование позиции"/>
          <input class="inputT" style="width: 213px;" placeholder="URL"/>
          <input class="inputT" style="width: 270px;" placeholder="поставщик"/>
          <div class="select-wrapper" style="width:90px; margin-left:32px;">
             <input class="input select-input" style="width:90px;" placeholder="изм." readonly />
          </div>
          <input class="inputSUM" style="width: 86px;" placeholder="000 000"/>
          <input class="inputSUM" placeholder="000 000 000"/>
        </div>
      </div>
      <button class="button-form" style="width: 330px; left: 163px;" id="create-order">
        создать позицию заказа
      </button>
    </div>
  </div>
  <!-- Нижняя часть модального окна -->
  <div class="modal-bottom" style="margin-top: 24px;">
    <div class="modalVNUT-content">
      <!-- Здесь будут отображаться блоки заказов, добавленные пользователем -->
    </div>
  </div>
</div>

<!-- Скрипт (type="module") с инициализацией Supabase и функцией initModal1() -->
<script type="module">
  // Инициализация Supabase (предполагаем, что window.supabase уже инициализирован)
  const supabase = window.supabase;
  const USER_KEY = window.USER_KEY;

  // Если загружаем напрямую (без динамики), сразу вызовем initModal1()
  initModal1();

  // Если загружаем динамически через fetch + innerHTML — 
  // то браузер при вставке <script> не выполняет его сам.
  // Ваш код (в родительском index.html) должен после вставки вызвать initModal1().
  // Или можно убрать строку "initModal1();" выше и всегда звать вручную.
  
  function initModal1() {
  console.log('[modal1.html] Модуль PAGE 1 активирован!');

  // ──────────────────────────────────────────────────────────
  // 0.  СПРАВОЧНИК ЕДИНИЦ ИЗМЕРЕНИЙ  // +++ новый код +++
  // ──────────────────────────────────────────────────────────
  async function loadUnitsMeasure() {
    const { data, error } = await supabase
      .from('units_measure')
      .select('unit_name, unit_group, multiplier')
      .order('unit_group, multiplier');
    if (error) { console.error(error); return []; }
    return data || [];
  }
  const unitsPromise = loadUnitsMeasure();   // сразу запускаем загрузку

  // ──────────────────────────────────────────────────────────
  // 1.  ЗАГРУЗКА УЖЕ СУЩЕСТВУЮЩИХ ЗАКАЗОВ
  // ──────────────────────────────────────────────────────────
  loadExistingOrders();

  // запись заказа в таблицу "orders"
  async function insertOrderToDB(orderData) {                // //функция записи заказа
    const { data, error } = await supabase
      .from('orders')
      .insert([orderData]);
    if (error) throw error;
    return data;
  }

  // загрузка существующих заказов
  async function loadExistingOrders() {                      // //загрузка заказов
    const ordersContainer = document.querySelector(
      '#modal1-container .modal-bottom .modalVNUT-content'
    );

    const { data: orders, error } = await supabase
      .from('orders')
      .select('*')
      .eq('user_key', USER_KEY)
      .order('created_at', { ascending: true });

    if (error) { console.error(error); return; }
    if (!orders || !orders.length) return;

    orders.forEach(order => {
      ordersContainer.insertAdjacentHTML(
        'beforeend',
        createOrderElement(order)
      );
      if (order.url) {
        const icon = ordersContainer.lastElementChild.querySelector('.spec-icon');
        icon.addEventListener('click', () => window.open(order.url, '_blank'));
      }
    });

    // обновляем счётчик «размещено заказов»
    const totalCounter = document.querySelector(
      '#modal1-container .stats .stat-value'
    );
    if (totalCounter) totalCounter.textContent = orders.length.toLocaleString();
  }

  // ──────────────────────────────────────────────────────────
  // 2.  КАСТОМНЫЙ SELECT "изм."         // +++ новый код +++
  // ──────────────────────────────────────────────────────────
  setupCustomSelect();                                      // //инициализация select

  async function setupCustomSelect(){
  const units = await unitsPromise;

  const localInput = document.querySelector('#modal1-container .select-input');
  const portal     = document.getElementById('global-select-dropdown');
  const overlay    = document.getElementById('select-overlay');
  if(!localInput || !portal || !overlay) return;

  /* заполняем список (один раз) */
  if(!portal.hasChildNodes()){
    const frag=document.createDocumentFragment();
    units.forEach(u=>{
      const o=document.createElement('div');
      o.className='select-option';
      o.textContent=u.unit_name;
      o.dataset.group=u.unit_group;
      o.dataset.multiplier=u.multiplier;
      frag.appendChild(o);
    });
    portal.appendChild(frag);
  }

  /* показать */
  localInput.addEventListener('click',e=>{
    e.stopPropagation();
    const rect = localInput.getBoundingClientRect();
    portal.style.left = rect.left + 'px';
    portal.style.top  = (rect.bottom + window.scrollY) + 'px';
    portal.classList.add('show');
    overlay.style.display='block';
  });

  /* выбор */
  portal.addEventListener('click',e=>{
    if(!e.target.classList.contains('select-option')) return;
    localInput.value = e.target.textContent;
    closeDropdown();
  });

  /* клик по фону — закрыть */
  overlay.addEventListener('click', closeDropdown);

  function closeDropdown(){
    portal.classList.remove('show');
    overlay.style.display='none';
  }
}

    /*───────────────────────────────────────────────────────────
  3‑bis.  Форматирование полей .inputSUM (тысячи + округление)
───────────────────────────────────────────────────────────*/
(function attachSumFormatters(){
  /** helper: красивый вывод (разделители тысяч, без копеек) */
  const fmt = n => Math.round(n).toLocaleString('ru-RU');

  /** helper: парсим строку → число */
  const parseNum = s => parseFloat(
    String(s).replace(/[\s ]/g,'').replace(',','.')
  );

  /** ставим обработчики focus / blur на один элемент */
  function bind(el){
    if(el.dataset.bindSum==='1') return;         // уже привязан

    // ► при фокусе показываем «сырое» значение с копейками
    el.addEventListener('focus', ()=>{
      const raw = el.dataset.raw ?? parseNum(el.value);
      if(!isNaN(raw)) el.value = Number(raw).toFixed(2);
    });

    // ► при уходе с поля форматируем и запоминаем raw‑число
    el.addEventListener('blur', ()=>{
      const raw = parseNum(el.value);
      if(isNaN(raw)){ el.value=''; el.dataset.raw=''; return; }
      el.dataset.raw = raw;                     // сохраняем как есть
      el.value = fmt(raw);                      // округляем и добавляем пробелы
    });

    // помечаем, что обработчики уже добавлены
    el.dataset.bindSum = '1';
    // если изначально есть значение — сразу форматируем
    if(el.value) el.dispatchEvent(new Event('blur'));
  }

  /** привязать форматирование к всем .inputSUM внутри node */
  function bindInside(node=document){
    node.querySelectorAll('.inputSUM').forEach(bind);
  }

  // 1) существующие поля
  bindInside();

  // 2) новые поля при загрузке заказов
  const origCreate = createOrderElement;              // перехватываем генерацию
  createOrderElement = (...args)=>{
    const html = origCreate(...args);
    // маленькая хитрость: после вставки HTML привяжем форматирование
    setTimeout(()=> bindInside(ordersContainer), 0);
    return html;
  };
})();



  // ──────────────────────────────────────────────────────────
  // 3.  ГЕНЕРАЦИЯ HTML ДЛЯ ЗАКАЗА
  // ──────────────────────────────────────────────────────────
  function createOrderElement(orderData) {                  // //генерация HTML
    return `
      <div class="modalBLOCK">
        <label>
          <input type="checkbox" class="input">
          <span class="custom-checkbox" style="margin-top:5px;margin-left:-8px;"></span>
        </label>
        <div class="modalRow">
          <input class="inputT" style="width:130px;" placeholder="RIV-0881" value="${orderData.orderCode||''}" readonly/>
          <input class="input"  style="width:340px;" placeholder="наименование позиции" value="${orderData.name||''}" readonly/>
          <input class="input"  style="width:150px;" placeholder="статус" value="заказано" readonly/>
          <span class="spec-icon" style="margin-left:30px;" data-url="${orderData.url||''}">
            <i class="material-symbols-outlined">captive_portal</i>
          </span>
          <input class="inputT" style="width:270px;" placeholder="поставщик" value="${orderData.supplier||''}" readonly/>
          <input class="input select-input" style="width:90px;margin-left:30px;" placeholder="изм." value="${orderData.modification||''}" readonly/>
          <input class="inputSUM" style="width:86px;" placeholder="000 000" value="${orderData.field1||''}" readonly/>
          <input class="inputSUM" placeholder="000 000 000" value="${orderData.field2||''}" readonly/>
        </div>
        <div class="modalRow" style="margin-left:30px;">
          <input class="input"  style="width:90px;" placeholder="изм." readonly/>
          <input class="inputSUM" style="width:86px;" placeholder="000 000" readonly/>
          <input class="inputSUM" placeholder="000 000 000" readonly/>
          <input class="inputSUM" placeholder="000 000 000" readonly/>
        </div>
      </div>
    `;
  }

  // ──────────────────────────────────────────────────────────
  // 4.  ОЧИСТКА ВЕРХНЕЙ ФОРМЫ
  // ──────────────────────────────────────────────────────────
  function clearForm() {                                   // //очистка формы
    const formBlock = document.querySelector('#modal1-container .modal-top .modalBLOCK');
    if (!formBlock) return;

    // очищаем все input‑ы
    const inputs = formBlock.querySelectorAll('.modalRow input');
    inputs.forEach(i => i.value = '');

    // дополнительно очищаем select‑input  // +++ новый код +++
    const selInput = formBlock.querySelector('.select-input');
    if (selInput) selInput.value = '';
  }

  // ──────────────────────────────────────────────────────────
  // 5.  СОЗДАНИЕ НОВОЙ ПОЗИЦИИ ЗАКАЗА (кнопка)
  // ──────────────────────────────────────────────────────────
  const createOrderBtn = document.getElementById('create-order');
  if (createOrderBtn) {
    createOrderBtn.addEventListener('click', async () => {
      const formBlock = document.querySelector('#modal1-container .modal-top .modalBLOCK');
      if (!formBlock) return;

      const inputs = formBlock.querySelectorAll('.modalRow input');
      const orderData = {                                   // //формируем объект
        user_key:     USER_KEY,
        orderCode:    inputs[0].value.trim(),
        name:         inputs[1].value.trim(),
        url:          inputs[2].value.trim(),
        supplier:     inputs[3].value.trim(),
        modification: inputs[4].value.trim(),               // здесь хранится «изм.»
        field1:       inputs[5].value.trim(),
        field2:       inputs[6].value.trim(),
        status:      "заказано"
      };

      if (!orderData.orderCode || !orderData.name) {
        alert("Пожалуйста, заполните обязательные поля (код и наименование).");
        return;
      }

      try {
        await insertOrderToDB(orderData);                    // //запись в БД
        const ordersContainer = document.querySelector('#modal1-container .modal-bottom .modalVNUT-content');
        ordersContainer.insertAdjacentHTML('beforeend', createOrderElement(orderData));
        clearForm();                                         // //очистка формы

        // привязываем URL на иконку
        if (orderData.url) {
          const newIcon = ordersContainer.querySelector(`.spec-icon[data-url="${orderData.url}"]`);
          if (newIcon) newIcon.addEventListener('click', () => window.open(orderData.url, '_blank'));
        }

      } catch (error) {
        alert("Ошибка при создании заказа: " + error.message);
        console.error(error);
      }
    });
  }

  // ──────────────────────────────────────────────────────────
  // 6.  ПРОЧИЕ КНОПКИ
  // ──────────────────────────────────────────────────────────
  const moveWarehouseBtn  = document.getElementById('move-warehouse');
  const deleteSelectedBtn = document.getElementById('delete-selected');

  moveWarehouseBtn  && moveWarehouseBtn.addEventListener('click', () => console.log('Перемещение на склад'));
  deleteSelectedBtn && deleteSelectedBtn.addEventListener('click', () => console.log('Удаление выбранного'));
}

</script>
