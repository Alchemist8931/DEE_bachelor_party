<!-- ========= modal1.html (Проект 2) ========= -->

<!-- Стили локального модуля -->
<style>
  /* Контейнер модуля */
  #modal1-container {
    font-family: 'Comfortaa', sans-serif;
    width: 100%;
    max-width: 1920px;
    margin: 0 auto;
  }
  /* Верхняя часть модального окна */
  #modal1-container .modal-top {
    width: 100%;
    max-width: 1920px;
    margin: 0 auto;
    height: 330px;
    background-color: #f5f5f5;
    border-radius: 12px;
    border: 1px solid rgba(0, 0, 0, 0.10);
    box-shadow: 6px 6px 16px rgba(22,20,19,0.4);
    padding: 20px;
    overflow: hidden;
    z-index: 1100;
  }
  /* Нижняя часть модального окна */
  #modal1-container .modal-bottom {
    width: 100%;
    max-width: 1920px;
    margin: 0 auto;
    height: calc(100vh - 395px);
    background-color: #f5f5f5;
    border-radius: 12px;
    border: 1px solid rgba(0, 0, 0, 0.10);
    box-shadow: 6px 6px 16px rgba(22,20,19,0.4);
    padding: 20px;
    overflow-x: hidden;
    overflow-y: auto;
    z-index: 1100;
  }
  /* Общий стиль для строк блока */
  #modal1-container .modalRow {
    display: flex;
    position: relative;
    flex-direction: row;
    background: none;
    gap: 10px;
  }
  #modal1-container .modalColumn {
    display: flex;
    position: relative;
    flex-direction: column;
    background: none;
    gap: 10px;
  }
  /* Контейнер для отображения заказов */
  #modal1-container .modalVNUT-content {
    padding: 0 20px 0 0;
    height: 100%;
    width: 100%;
    overflow-y: scroll;
    box-sizing: border-box;
  }
  /* Стилизация скроллбара */
  #modal1-container .modalVNUT-content::-webkit-scrollbar {
    width: 4px;
    background-color: #e2e2e2;
    border-radius: 20px;
  }
  #modal1-container .modalVNUT-content::-webkit-scrollbar-thumb {
    background-color: #212121;
    border-radius: 20px;
  }
  #modal1-container .modalVNUT-content::-webkit-scrollbar-track {
    background-color: #e2e2e2;
  }
  #modal1-container .modalVNUT-content .modalBLOCK{
  transition:transform .25s ease, opacity .25s ease;
}
/* впервые вставленный блок */
#modal1-container .modalVNUT-content .modalBLOCK.appear{
  opacity:0;
  transform:translateY(-16px);
}

  /* Блок-контейнер (форма ввода заказа) */
  #modal1-container .modalBLOCK {
    gap: 14px;
    display: flex;
    position: relative;
    padding: 10px;
    height: auto;
    color: black;
    z-index: 1100;
    box-sizing: border-box;
    vertical-align: middle;
    background: none;
    backdrop-filter: blur(0px);
    -webkit-backdrop-filter: blur(0px);
    border-radius: 10px;
    margin-top: -10px;
  }
  #modal1-container .modalBLOCK:hover,
  #modal1-container .modalBLOCK:focus {
    background: rgba(255, 255, 255, 0.05);
  }
  /* Стили для input полей */
  #modal1-container .inputT,
  #modal1-container .input,
  #modal1-container .inputSUM {
    padding: 7px;
    border-radius: 8px;
    font-size: 12px;
    font-weight: 500;
    border: 1px solid #E5E7E9;
    outline: none;
    transition: all 1s cubic-bezier(0.19, 1, 0.22, 1);
    box-shadow: 0px 0px 20px -18px;
    background: #f5f5f5;
    font-variant-numeric: tabular-nums;
  }
  #modal1-container .inputT {
    width: 250px;
    text-transform: uppercase;
  }
  #modal1-container .input {
    width: 250px;
  }
  #modal1-container .inputSUM {
    width: 116px;
    text-align: right;
  }
  #modal1-container .inputT:active,
  #modal1-container .input:active,
  #modal1-container .inputSUM:active {
    transform: scale(0.95);
  }
  #modal1-container .inputT:focus,
  #modal1-container .input:focus,
  #modal1-container .inputSUM:focus {
    border: 1px solid #1a1a1a;
  }

  /* ---- кастомный select ---- */
#global-select-dropdown{
  position:fixed;               /* за пределами всех модальных блоков */
  max-height: 160px; width: 160px;
  background: #f5f5f5; border: 1px solid #E5E7E9;
  border-radius: 8px; box-shadow: 0 4px 16px rgba(22,20,19,.25);
  overflow-y:auto; opacity:0; visibility: hidden;
  transform:translateY(-10px);  transition:.25s;
  z-index:9999;
  margin-top: 6px;
}
#global-select-dropdown.show{ opacity:1; visibility:visible; transform:translateY(0); }
#global-select-dropdown::-webkit-scrollbar{
  width:4px; background:#e2e2e2; border-radius:20px;
}
#global-select-dropdown::-webkit-scrollbar-thumb{
  background:#212121; border-radius:20px;
}
#global-select-dropdown .select-option{
  padding:6px 10px; font-size:12px; cursor:pointer;
}
#global-select-dropdown .select-option:hover{ background:rgba(0,0,0,.05); }

/* лёгкий затемнённый фон, чтобы закрывать по клику */
#select-overlay{
  position:fixed; inset:0; background:transparent;
  z-index:9998; display:none;
}

  
  /* Иконка (URL) */
  #modal1-container .spec-icon {
    color: #212121;
    font-size: 20px;
    cursor: pointer;
    display: flex;
    align-items: center;
    position: relative;
  }
  #modal1-container .spec-icon:hover {
    color: #625a56;
    transform: scale(1.1);
  }
  #modal1-container .spec-icon:active {
    transform: scale(0.92);
  }
  /* Чекбокс */
  #modal1-container .input[type="checkbox"] {
    display: none;
  }
  #modal1-container .custom-checkbox {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 2px solid #333;
    border-radius: 4px;
    position: relative;
    cursor: pointer;
  }
  #modal1-container .custom-checkbox::after {
    content: "";
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 10px;
    height: 10px;
    background-color: #333;
    border-radius: 2px;
    opacity: 0;
  }
  #modal1-container .input[type="checkbox"]:checked + .custom-checkbox::after {
    opacity: 1;
  }
  /* Кнопки */
  #modal1-container .button-form {
    position: relative;
    width: 200px;
    height: 30px;
    background-color: #212121;
    border: 1px solid #212121;
    color: #f5f5f5;
    cursor: pointer;
    transition: all 0.4s;
    padding: 7px;
    border-radius: 8px;
    font-size: 12px;
    font-weight: 600;
  }
  #modal1-container .button-form:hover {
    color: #212121;
    background-color: #f5f5f5;
  }
  /* ---- плавное появление action-buttons ---- */
#modal1-container .action-buttons{
  opacity:0;                    /* спрятано по умолчанию   */
  pointer-events:none;          /* клики не проходят       */
  transform:translateY(-6px);   /* лёгкий подъём наверх    */
  transition:opacity .5s ease, transform .5s ease;
}

#modal1-container .action-buttons.visible{
  opacity:1;                    /* полностью видно         */
  pointer-events:auto;          /* снова кликабельно       */
  transform:translateY(0);      /* возвращаемся на место   */
}
  
  /* Статистика (три прямоугольника вверху) */
  #modal1-container .stats {
    display: inline-grid;
    background-color: transparent;
    color: #212121;
    border-radius: 12px;
    border: none;
  }
  #modal1-container .stat {
    display: inline-grid;
    width: 500px;
    grid-template-columns: repeat(1, 1fr);
    column-gap: 10px;
    padding: 20px;
  }
  #modal1-container .stat-title {
    grid-column-start: 1;
    white-space: nowrap;
    color: #212121;
    font-size: 14px;
    text-transform: uppercase;
    font-weight: 800;
  }
  #modal1-container .stat-value {
    grid-column-start: 1;
    white-space: nowrap;
    font-size: 30px;
    line-height: 16px;
    font-weight: 700;
    margin-top: 18px;
  }
</style>

<!-- Основная разметка modal1 -->
<div id="modal1-container">

<!-- ——— портальный контейнер для выпадающего списка ——— -->
<div id="select-overlay"></div>
<div id="global-select-dropdown"></div>
  
  <!-- Верхняя часть модального окна -->
  <div class="modal-top">
    <div class="modalRow">
      <div class="stats shadow">
        <div class="stat">
          <div class="stat-title">размещено заказов</div>
          <div class="stat-value">000 000 000</div>
        </div>
      </div>
      <div class="stats shadow">
        <div class="stat">
          <div class="stat-title">на сумму</div>
          <div class="stat-value">000 000 000</div>
        </div>
      </div>
    </div>
    
    <div class="modalRow action-buttons" style="top: 150px; margin-left: 1400px;">
      <button class="button-form" style="width: 230px; left: 5px;" id="move-warehouse">
        переместить на склад
      </button>
      <button class="button-form" style="width: 230px; left: 15px;" id="delete-selected">
        удалить выбранное
      </button>
    </div>
    
    <div class="modalRow" style="top: 102px;">
      <div class="modalBLOCK" style="margin-left: 26px; margin-top: -4px;">
        <div class="modalRow">
          <input class="inputT" style="width: 130px;" placeholder="RIV-0881"/>
          <input class="input"  style="width: 340px;" placeholder="наименование позиции"/>
          <input class="inputT" style="width: 213px;" placeholder="URL"/>
          <input class="inputT" style="width: 270px;" placeholder="поставщик"/>
          <div class="select-wrapper" style="width:90px; margin-left:32px;">
             <input class="input select-input" style="width:90px;" placeholder="изм." readonly />
          </div>
          <input class="inputSUM" style="width: 86px;" placeholder="000 000"/>
          <input class="inputSUM" placeholder="000 000 000"/>
        </div>
      </div>
      <button class="button-form" style="width: 330px; left: 163px;" id="create-order">
        создать позицию заказа
      </button>
    </div>
  </div>
  <!-- Нижняя часть модального окна -->
  <div class="modal-bottom" style="margin-top: 24px;">
    <div class="modalVNUT-content">
      <!-- Здесь будут отображаться блоки заказов, добавленные пользователем -->
    </div>
  </div>
</div>

<!-- Скрипт (type="module") с инициализацией Supabase и функцией initModal1() -->
<script type="module">
  const supabase = window.supabase;
  const USER_KEY = window.USER_KEY;

  initModal1();

  function initModal1() {
    console.log('[modal1.html] PAGE 1 активирован');

const ordersContainer = document.querySelector(
  '#modal1-container .modal-bottom .modalVNUT-content'
);
    
/* ---------- 0. справочник единиц ---------- */
    async function loadUnitsMeasure() {
      const { data, error } = await supabase
        .from('units_measure')
        .select('unit_name, unit_group, multiplier')
        .order('unit_group, multiplier');
      if (error) { console.error(error); return []; }
      return data || [];
    }
    const unitsPromise = loadUnitsMeasure();

    /* helpers */
const fmtNum = n => Number(n || 0).toLocaleString('ru-RU');
    
    function getBaseUnit(unitName, units) {
      const cur = units.find(u => u.unit_name === unitName);
      if (!cur) return unitName;
      return units
        .filter(u => u.unit_group === cur.unit_group)
        .sort((a, b) => a.multiplier - b.multiplier)[0]
        .unit_name;
    }
    function getMultiplier(unitName, units) {
      const u = units.find(x => x.unit_name === unitName);
      return u ? Number(u.multiplier) : 1;
    }

    /* аккуратно превращаем строку‑число (“1 234,56”) → 1234.56 */
    function parseFloatSafe(str=''){
    return parseFloat(
       String(str).replace(/[\s ]/g,'').replace(',','.')
      ) || 0;
    }

    /* ---------- 1. загрузка существующих заказов ---------- */
    loadExistingOrders();

    async function insertOrderToDB(obj) {
      const { data, error } = await supabase.from('orders').insert([obj]);
      if (error) throw error;
      return data;
    }

    async function loadExistingOrders() {
      const units = await unitsPromise;
      const ordersContainer = document.querySelector(
        '#modal1-container .modal-bottom .modalVNUT-content'
      );

      const { data: orders, error } = await supabase
        .from('orders')
        .select('*')
        .eq('user_key', USER_KEY)
        .order('created_at', { ascending: false });

      if (error) { console.error(error); return; }
      if (!orders?.length) return;

      orders.forEach(order => {
        order.base_unit = getBaseUnit(order.modification, units);
        order.qtySel       = Number(order.field1 || 0);
        const multMod       = getMultiplier(order.modification, units);
        order.multMod       = multMod;                    /* A */
        order.priceSel   = parseFloatSafe(order.field2);
        order.baseQty    = order.qtySel * multMod;
        order.priceBase     = multMod ? order.priceSel / multMod : 0; /* E */
        order.total         = order.priceBase * multMod;  /* F */

        ordersContainer.insertAdjacentHTML('beforeend', createOrderElement(order));

        if (order.url) {
          ordersContainer.lastElementChild
            .querySelector('.spec-icon')
            .addEventListener('click', () => window.open(order.url, '_blank'));
        }
      });

      const totalCounter = document.querySelector('#modal1-container .stats .stat-value');
      if (totalCounter) totalCounter.textContent = orders.length.toLocaleString();
    }

  // ──────────────────────────────────────────────────────────
  // 2.  КАСТОМНЫЙ SELECT "изм."         // +++ новый код +++
  // ──────────────────────────────────────────────────────────
  setupCustomSelect();                                      // //инициализация select

  async function setupCustomSelect(){
  const units = await unitsPromise;

  const localInput = document.querySelector('#modal1-container .select-input');
  const portal     = document.getElementById('global-select-dropdown');
  const overlay    = document.getElementById('select-overlay');
  if(!localInput || !portal || !overlay) return;

  /* заполняем список (один раз) */
  if(!portal.hasChildNodes()){
    const frag=document.createDocumentFragment();
    units.forEach(u=>{
      const o=document.createElement('div');
      o.className='select-option';
      o.textContent=u.unit_name;
      o.dataset.group=u.unit_group;
      o.dataset.multiplier=u.multiplier;
      frag.appendChild(o);
    });
    portal.appendChild(frag);
  }

  /* показать */
  localInput.addEventListener('click',e=>{
    e.stopPropagation();
    const rect = localInput.getBoundingClientRect();
    portal.style.left = rect.left + 'px';
    portal.style.top  = (rect.bottom + window.scrollY) + 'px';
    portal.classList.add('show');
    overlay.style.display='block';
  });

  /* выбор */
  portal.addEventListener('click',e=>{
    if(!e.target.classList.contains('select-option')) return;
    localInput.value = e.target.textContent;
    closeDropdown();
  });

  /* клик по фону — закрыть */
  overlay.addEventListener('click', closeDropdown);

  function closeDropdown(){
    portal.classList.remove('show');
    overlay.style.display='none';
  }
}

    /*────────────────────────────────────────────────────────────
  3.  Кнопки «переместить / удалить» показываем,
      только когда выбран хотя бы один чекбокс
────────────────────────────────────────────────────────────*/
/* === НОВАЯ плавная анимация кнопок === */
const actionRow = document.querySelector('#modal1-container .action-buttons'); // div с двумя кнопками

function updateActionButtons(){
  const checked = document.querySelector(
    '#modal1-container .modalVNUT-content input[type="checkbox"]:checked'
  );
  actionRow.classList.toggle('visible', !!checked);   // добавляем/убираем класс
}

document.querySelector('#modal1-container .modalVNUT-content')
        .addEventListener('change', e=>{
          if(e.target.matches('input[type="checkbox"]')) updateActionButtons();
        });

updateActionButtons();   // первый запуск



    /*───────────────────────────────────────────────────────────
  3‑bis.  Форматирование полей .inputSUM (тысячи + округление)
───────────────────────────────────────────────────────────*/
(function attachSumFormatters(){
  /** helper: красивый вывод (разделители тысяч, без копеек) */
  const fmt = n => Math.round(n).toLocaleString('ru-RU');

  /** helper: парсим строку → число */
  const parseNum = s => parseFloat(
    String(s).replace(/[\s ]/g,'').replace(',','.')
  );

  /** ставим обработчики focus / blur на один элемент */
  function bind(el){
    if(el.dataset.bindSum==='1') return;         // уже привязан

    // ► при фокусе показываем «сырое» значение с копейками
    el.addEventListener('focus', ()=>{
      const raw = el.dataset.raw ?? parseNum(el.value);
      if(!isNaN(raw)) el.value = Number(raw).toFixed(2);
    });

    // ► при уходе с поля форматируем и запоминаем raw‑число
    el.addEventListener('blur', ()=>{
      const raw = parseNum(el.value);
      if(isNaN(raw)){ el.value=''; el.dataset.raw=''; return; }
      el.dataset.raw = raw;                     // сохраняем как есть
      el.value = fmt(raw);                      // округляем и добавляем пробелы
    });

    // помечаем, что обработчики уже добавлены
    el.dataset.bindSum = '1';
    // если изначально есть значение — сразу форматируем
    if(el.value) el.dispatchEvent(new Event('blur'));
  }

  /** привязать форматирование к всем .inputSUM внутри node */
  function bindInside(node=document){
    node.querySelectorAll('.inputSUM').forEach(bind);
  }

  // 1) существующие поля
  bindInside();

  // 2) новые поля при загрузке заказов
  const origCreate = createOrderElement;              // перехватываем генерацию
  createOrderElement = (...args)=>{
    const html = origCreate(...args);
    // маленькая хитрость: после вставки HTML привяжем форматирование
    setTimeout(()=> bindInside(ordersContainer), 0);
    return html;
  };
})();



 /* ---------- 4. шаблон контейнера заказа ---------- */
    function createOrderElement(o) {
      return `
      <div class="modalBLOCK">
        <label>
          <input type="checkbox" class="input">
          <span class="custom-checkbox" style="margin-top:5px;margin-left:-8px;"></span>
        </label>
        <div class="modalRow">
          <input class="inputT"  style="width:130px;" placeholder="RIV-0881"    value="${o.orderCode||''}" readonly/>
          <input class="input"   style="width:340px;" placeholder="наименование" value="${o.name||''}"      readonly/>
          <input class="input"   style="width:150px;" placeholder="статус"       value="заказано"            readonly/>
          <span  class="spec-icon" style="margin-left: 30px;" data-url="${o.url||''}">
            <i class="material-symbols-outlined">captive_portal</i>
          </span>
          <input class="inputT"  style="width:270px;" placeholder="поставщик"    value="${o.supplier||''}"   readonly/>
          <input class="input"   style="width:90px;margin-left: 30px;" placeholder="изм." value="${o.modification||''}" readonly/>
          <input class="inputSUM" style="width:86px;" placeholder="000 000" value="${fmtNum(o.qtySel)}" readonly/>
          <input class="inputSUM" placeholder="000 000 000" value="${fmtNum(o.priceSel)}" readonly/>  
        </div>

        <div class="modalRow" style="margin-left:30px;">
          <input class="input" style="width:90px;" placeholder="изм." value="${o.base_unit||''}" readonly/>
          <input class="inputSUM" style="width:86px;" placeholder="000 000"          value="${fmtNum(o.baseQty)}" readonly/>
          <input class="inputSUM"                 placeholder="000 000 000"           value="${fmtNum(o.priceBase)}" readonly/>
          <input class="inputSUM"                 placeholder="000 000 000"           value="${fmtNum(o.total)}" readonly/>
        </div>
      </div>`;
    }

  /* ──────────────────────────────────────────────
   ОЧИСТКА ВЕРХНЕЙ ФОРМЫ после создания позиции
────────────────────────────────────────────── */
function clearForm(){
  const formBlock = document.querySelector(
    '#modal1-container .modal-top .modalBLOCK'
  );
  if(!formBlock) return;

  const inputs = formBlock.querySelectorAll('.modalRow input');
  inputs.forEach(inp=>{
    inp.value = '';

    /* если это поле суммы — забудем прежний raw‑кеш */
    if(inp.classList.contains('inputSUM')){
      delete inp.dataset.raw;          //  <‑‑ ключевой момент
    }
  });

  /* очистим select «изм.» */
  const sel = formBlock.querySelector('.select-input');
  if(sel) sel.value='';
}


  /* ---------- 6. создание новой позиции ---------- */
    const createOrderBtn = document.getElementById('create-order');
    if (createOrderBtn) {
      createOrderBtn.addEventListener('click', async () => {
        const formBlock = document.querySelector('#modal1-container .modal-top .modalBLOCK');
        if (!formBlock) return;

        const inputs = formBlock.querySelectorAll('.modalRow input');
        const units  = await unitsPromise;

        const orderData = {
          user_key:     USER_KEY,
          orderCode:    inputs[0].value.trim(),
          name:         inputs[1].value.trim(),
          url:          inputs[2].value.trim(),
          supplier:     inputs[3].value.trim(),
          modification: inputs[4].value.trim(),
          base_unit:    getBaseUnit(inputs[4].value.trim(), units),
          field1:       inputs[5].value.trim(),   /* оставляем как есть */
          field2:       inputs[6].value.trim(),   /* цена за выбранную */
          status:      "заказано"
        };

        if (!orderData.orderCode || !orderData.name) {
          alert('Заполните обязательные поля (код и наименование)');
          return;
        }

        /* вычисляем дополнительные показатели */
        const multMod   = getMultiplier(orderData.modification, units);
        orderData.multMod    = multMod;
        orderData.qtySel     = Number(orderData.field1||0);
        orderData.priceSel   = parseFloatSafe(orderData.field2);
        orderData.priceBase  = multMod ? orderData.priceSel / multMod : 0;
        orderData.total      = orderData.priceBase * multMod;
        orderData.baseQty    = orderData.qtySel * multMod;

        try {
          const { base_unit, multMod:_, priceSel:__, priceBase:___, total:____, qtySel:_____, baseQty:_______, ...dbData } = orderData;
          await insertOrderToDB(dbData);                         // пишем только то, что есть в колонках

          const ordersContainer = document.querySelector('#modal1-container .modal-bottom .modalVNUT-content');
          ordersContainer.insertAdjacentHTML('afterbegin', createOrderElement(orderData));

          const newEl = ordersContainer.firstElementChild;
          newEl.classList.add('appear');
          requestAnimationFrame(() => newEl.classList.remove('appear'));

          updateActionButtons();
          clearForm();

          if (orderData.url) {
            newEl.querySelector('.spec-icon').addEventListener('click', () => window.open(orderData.url, '_blank'));
          }

        } catch (err) {
          alert('Ошибка при создании заказа: ' + err.message);
          console.error(err);
        }
      });
    }

  // ──────────────────────────────────────────────────────────
  // 6.  ПРОЧИЕ КНОПКИ
  // ──────────────────────────────────────────────────────────
  const moveWarehouseBtn  = document.getElementById('move-warehouse');
  const deleteSelectedBtn = document.getElementById('delete-selected');

  moveWarehouseBtn  && moveWarehouseBtn.addEventListener('click', () => console.log('Перемещение на склад'));
  deleteSelectedBtn && deleteSelectedBtn.addEventListener('click', () => console.log('Удаление выбранного'));
}

</script>
