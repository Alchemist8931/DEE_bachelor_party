<!-- ========= modal1.html (Проект 2) ========= -->

<!-- Стили локального модуля -->
<style>
  /* Контейнер модуля */
  #modal1-container {
    font-family: 'Comfortaa', sans-serif;
    width: 100%;
    max-width: 1920px;
    margin: 0 auto;
  }
  /* Верхняя часть модального окна */
  #modal1-container .modal-top {
    width: 100%;
    max-width: 1920px;
    margin: 0 auto;
    height: 165px;
    background-color: #f5f5f5;
    border-radius: 12px;
    border: 1px solid rgba(0, 0, 0, 0.10);
    box-shadow: 6px 6px 16px rgba(22,20,19,0.4);
    padding: 20px;
    overflow: hidden;
    z-index: 1100;
  }
  /* Нижняя часть модального окна */
  #modal1-container .modal-bottom {
    width: 100%;
    max-width: 1920px;
    margin: 0 auto;
    height: calc(100vh - 230px);
    background-color: #f5f5f5;
    border-radius: 12px;
    border: 1px solid rgba(0, 0, 0, 0.10);
    box-shadow: 6px 6px 16px rgba(22,20,19,0.4);
    padding: 20px;
    overflow-x: hidden;
    overflow-y: auto;
    z-index: 1100;
  }
  /* Общий стиль для строк блока */
  #modal1-container .modalRow {
    display: flex;
    position: relative;
    flex-direction: row;
    background: none;
    gap: 10px;
  }
  #modal1-container .modalColumn {
    display: flex;
    position: relative;
    flex-direction: column;
    background: none;
    gap: 10px;
  }
  /* Контейнер для отображения заказов */
  #modal1-container .modalVNUT-content {
    padding: 0 20px 0 0;
    height: 100%;
    width: 100%;
    overflow-y: scroll;
    box-sizing: border-box;
  }
  /* Стилизация скроллбара */
  #modal1-container .modalVNUT-content::-webkit-scrollbar {
    width: 4px;
    background-color: #e2e2e2;
    border-radius: 20px;
  }
  #modal1-container .modalVNUT-content::-webkit-scrollbar-thumb {
    background-color: #212121;
    border-radius: 20px;
  }
  #modal1-container .modalVNUT-content::-webkit-scrollbar-track {
    background-color: #e2e2e2;
  }
  #modal1-container .modalVNUT-content .modalBLOCK{
  transition:transform .25s ease, opacity .25s ease;
}
/* впервые вставленный блок */
#modal1-container .modalVNUT-content .modalBLOCK.appear{
  opacity:0;
  transform:translateY(-16px);
}

  /* Блок-контейнер (форма ввода заказа) */
  #modal1-container .modalBLOCK {
    gap: 14px;
    display: flex;
    position: relative;
    padding: 10px;
    height: auto;
    color: black;
    z-index: 1100;
    box-sizing: border-box;
    vertical-align: middle;
    background: none;
    backdrop-filter: blur(0px);
    -webkit-backdrop-filter: blur(0px);
    border-radius: 10px;
    margin-top: -10px;
  }
  #modal1-container .modalBLOCK:hover,
  #modal1-container .modalBLOCK:focus {
    background: rgba(255, 255, 255, 0.05);
  }
  /* Стили для input полей */
  #modal1-container .inputT,
  #modal1-container .input,
  #modal1-container .inputSUM {
    padding: 7px;
    border-radius: 8px;
    font-size: 12px;
    font-weight: 500;
    border: 1px solid #E5E7E9;
    outline: none;
    transition: all 1s cubic-bezier(0.19, 1, 0.22, 1);
    box-shadow: 0px 0px 20px -18px;
    background: #f5f5f5;
    font-variant-numeric: tabular-nums;
  }
  #modal1-container .inputT {
    width: 250px;
    text-transform: uppercase;
  }
  #modal1-container .input {
    width: 250px;
  }
  #modal1-container .inputSUM {
    width: 116px;
    text-align: right;
  }
  #modal1-container .inputT:active,
  #modal1-container .input:active,
  #modal1-container .inputSUM:active {
    transform: scale(0.95);
  }
  #modal1-container .inputT:focus,
  #modal1-container .input:focus,
  #modal1-container .inputSUM:focus {
    border: 1px solid #1a1a1a;
  }

  /* ---- кастомный select ---- */
#global-select-dropdown{
  position:fixed;               /* за пределами всех модальных блоков */
  max-height: 160px; width: 160px;
  background: #f5f5f5; border: 1px solid #E5E7E9;
  border-radius: 8px; box-shadow: 0 4px 16px rgba(22,20,19,.25);
  overflow-y:auto; opacity:0; visibility: hidden;
  transform:translateY(-10px);  transition:.25s;
  z-index:9999;
  margin-top: 6px;
}
#global-select-dropdown.show{ opacity:1; visibility:visible; transform:translateY(0); }
#global-select-dropdown::-webkit-scrollbar{
  width:4px; background:#e2e2e2; border-radius:20px;
}
#global-select-dropdown::-webkit-scrollbar-thumb{
  background:#212121; border-radius:20px;
}
#global-select-dropdown .select-option{
  padding:6px 10px; font-size:12px; cursor:pointer;
}
#global-select-dropdown .select-option:hover{ background:rgba(0,0,0,.05); }

/* лёгкий затемнённый фон, чтобы закрывать по клику */
#select-overlay{
  position:fixed; inset:0; background:transparent;
  z-index:9998; display:none;
}

  
  /* Иконка (URL) */
  #modal1-container .spec-icon {
    color: #212121;
    font-size: 20px;
    cursor: pointer;
    display: flex;
    align-items: center;
    position: relative;
  }
  #modal1-container .spec-icon:hover {
    color: #625a56;
    transform: scale(1.1);
  }
  #modal1-container .spec-icon:active {
    transform: scale(0.92);
  }
  /* Чекбокс */
  #modal1-container .input[type="checkbox"] {
    display: none;
  }
  #modal1-container .custom-checkbox {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 2px solid #333;
    border-radius: 4px;
    position: relative;
    cursor: pointer;
  }
  #modal1-container .custom-checkbox::after {
    content: "";
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 10px;
    height: 10px;
    background-color: #333;
    border-radius: 2px;
    opacity: 0;
  }
  #modal1-container .input[type="checkbox"]:checked + .custom-checkbox::after {
    opacity: 1;
  }
  /* Кнопки */
  #modal1-container .button-form {
    position: relative;
    width: 200px;
    height: 30px;
    background-color: #212121;
    border: 1px solid #212121;
    color: #f5f5f5;
    cursor: pointer;
    transition: all 0.4s;
    padding: 7px;
    border-radius: 8px;
    font-size: 12px;
    font-weight: 600;
  }
  #modal1-container .button-form:hover {
    color: #212121;
    background-color: #f5f5f5;
  }
  /* ---- плавное появление action-buttons ---- */
#modal1-container .action-buttons{
  opacity:0;                    /* спрятано по умолчанию   */
  pointer-events:none;          /* клики не проходят       */
  transform:translateY(-6px);   /* лёгкий подъём наверх    */
  transition:opacity .5s ease, transform .5s ease;
}

#modal1-container .action-buttons.visible{
  opacity:1;                    /* полностью видно         */
  pointer-events:auto;          /* снова кликабельно       */
  transform:translateY(0);      /* возвращаемся на место   */
}
  
  /* Статистика (три прямоугольника вверху) */
  #modal1-container .stats {
    display: inline-grid;
    background-color: transparent;
    color: #212121;
    border-radius: 12px;
    border: none;
  }
  #modal1-container .stat {
    display: inline-grid;
    width: 500px;
    grid-template-columns: repeat(1, 1fr);
    column-gap: 10px;
    padding: 20px;
  }
  #modal1-container .stat-title {
    grid-column-start: 1;
    white-space: nowrap;
    color: #212121;
    font-size: 14px;
    text-transform: uppercase;
    font-weight: 800;
  }
  #modal1-container .stat-value {
    grid-column-start: 1;
    white-space: nowrap;
    font-size: 30px;
    line-height: 16px;
    font-weight: 700;
    margin-top: 18px;
  }

  /* ====== анимация цифр счётчиков ====== */
@keyframes digit-pop{
  0%   {opacity:0; transform:translateY(0.6em) scale(0.8);}
  60%  {opacity:1; transform:translateY(-0.1em) scale(1.05);}
  100% {opacity:1; transform:translateY(0)      scale(1);}
}
#modal1-container .stat-value span{
  display:inline-block;
  animation:digit-pop .6s var(--delay,0s) cubic-bezier(.19,1,.22,1) both;
}
  
</style>

<!-- Основная разметка modal1 -->
<div id="modal1-container">

<!-- ——— портальный контейнер для выпадающего списка ——— -->
<div id="select-overlay"></div>
<div id="global-select-dropdown"></div>
  
  <!-- Верхняя часть модального окна -->
  <div class="modal-top">
    <div class="modalRow">
      <div class="stats shadow">
        <div class="stat">
          <div class="stat-title">размещено заказов</div>
          <div class="stat-value">000 000 000</div>
        </div>
      </div>
      <div class="stats shadow">
        <div class="stat">
          <div class="stat-title">на сумму</div>
          <div class="stat-value">000 000 000</div>
        </div>
      </div>
    </div>
    
    <div class="modalRow action-buttons" style="top: -22px; margin-left: 1400px;">
      <button class="button-form" style="width: 230px; left: 5px;" id="move-warehouse">
        переместить на склад
      </button>
      <button class="button-form" style="width: 230px; left: 15px;" id="delete-selected">
        удалить выбранное
      </button>
    </div>
    
    <div class="modalRow" style="top: -16px;">
      <div class="modalBLOCK" style="margin-left: 26px; margin-top: -4px;">
        <div class="modalRow">
          <input class="inputT" style="width: 130px;" placeholder="RIV-0881"/>
          <input class="input"  style="width: 340px;" placeholder="наименование позиции"/>
          <input class="inputT" style="width: 213px;" placeholder="URL"/>
          <input class="inputT" style="width: 270px;" placeholder="поставщик"/>
          <div class="select-wrapper" style="width:90px; margin-left:32px;">
             <input class="input select-input" style="width:90px;" placeholder="изм." readonly />
          </div>
          <input class="inputSUM" style="width: 86px;" placeholder="000 000"/>
          <input class="inputSUM" placeholder="000 000 000"/>
        </div>
      </div>
      <button class="button-form" style="width: 330px; left: 163px;" id="create-order">
        создать позицию заказа
      </button>
    </div>
  </div>
  <!-- Нижняя часть модального окна -->
  <div class="modal-bottom" style="margin-top: 24px;">
    <div class="modalVNUT-content">
      <!-- Здесь будут отображаться блоки заказов, добавленные пользователем -->
    </div>
  </div>
</div>

<!-- Скрипт (type="module") с инициализацией Supabase и функцией initModal1() -->
<!-- Скрипт (type="module") с полной актуальной логикой -->
<script type="module">
/*────────────────────────────────────────────────────────────
  Глобальные переменные
────────────────────────────────────────────────────────────*/
const supabase = window.supabase;
const USER_KEY = window.USER_KEY;

/* Точка входа */
initModal1();

/*────────────────────────────────────────────────────────────
  initModal1()
────────────────────────────────────────────────────────────*/
function initModal1 () {

  /*----------------------------------------------------------
    1. DOM‑ссылки и счётчики
  ----------------------------------------------------------*/
  const ordersContainer = document.querySelector(
    '#modal1-container .modal-bottom .modalVNUT-content'
  );

  const countEl = document.querySelectorAll('#modal1-container .stat-value')[0];
  const sumEl   = document.querySelectorAll('#modal1-container .stat-value')[1];

  let orderCnt = 0;
  let orderSum = 0;

  const num = s => parseFloat(String(s||0).replace(/[\s ]/g,'').replace(',','.')) || 0;

  function drawAnimated (el, value) {
    const txt = Number(value).toLocaleString('ru-RU');
    if (el.dataset.current === txt) return;
    el.dataset.current = txt;
    el.innerHTML = '';
    txt.split('').forEach((ch,i)=>{
      const span = document.createElement('span');
      span.textContent = ch;
      span.style.setProperty('--delay', i*0.05 + 's');
      el.appendChild(span);
    });
  }
  const redrawStats = () => { drawAnimated(countEl, orderCnt); drawAnimated(sumEl, orderSum); };

  /*----------------------------------------------------------
    2. helpers ‑ единицы измерений + форматирование
  ----------------------------------------------------------*/
  async function loadUnitsMeasure () {
    const { data, error } = await supabase
      .from('units_measure')
      .select('unit_name, unit_group, multiplier')
      .order('unit_group,multiplier');
    if (error) { console.error(error); return []; }
    return data||[];
  }
  const unitsPromise = loadUnitsMeasure();

  const fmtNum = n => Number(n||0).toLocaleString('ru-RU');

  const getBaseUnit = (name, units)=>{
    const cur = units.find(u=>u.unit_name===name);
    if(!cur) return name;
    return units.filter(u=>u.unit_group===cur.unit_group)
                .sort((a,b)=>a.multiplier-b.multiplier)[0].unit_name;
  };
  const getMultiplier = (name, units)=>{
    const u = units.find(x=>x.unit_name===name);
    return u ? Number(u.multiplier) : 1;
  };
  const parseFloatSafe = s=>parseFloat(String(s||0).replace(/[\s ]/g,'').replace(',','.'))||0;

  /*----------------------------------------------------------
    3. Кастомный SELECT «изм.»
  ----------------------------------------------------------*/
  setupCustomSelect();
  async function setupCustomSelect(){
    const units   = await unitsPromise;
    const inp     = document.querySelector('#modal1-container .select-input');
    const portal  = document.getElementById('global-select-dropdown');
    const overlay = document.getElementById('select-overlay');
    if(!inp||!portal||!overlay) return;

    if(!portal.hasChildNodes()){
      const frag=document.createDocumentFragment();
      units.forEach(u=>{
        const o=document.createElement('div');
        o.className='select-option';
        o.textContent=u.unit_name;
        o.dataset.group=u.unit_group;
        o.dataset.multiplier=u.multiplier;
        frag.appendChild(o);
      });
      portal.appendChild(frag);
    }

    inp.addEventListener('click',e=>{
      e.stopPropagation();
      const r=inp.getBoundingClientRect();
      portal.style.left=r.left+'px';
      portal.style.top=r.bottom+window.scrollY+'px';
      portal.classList.add('show');
      overlay.style.display='block';
    });
    portal.addEventListener('click',e=>{
      if(!e.target.classList.contains('select-option')) return;
      inp.value=e.target.textContent; close();
    });
    overlay.addEventListener('click',close);
    function close(){ portal.classList.remove('show'); overlay.style.display='none'; }
  }

  /*----------------------------------------------------------
    4. Форматирование inputSUM
  ----------------------------------------------------------*/
  (function attachSumFormatters(){
    const fmt=n=>Math.round(n).toLocaleString('ru-RU');
    const parse=s=>parseFloat(String(s).replace(/[\s ]/g,'').replace(',','.'));

    const bind=el=>{
      if(el.dataset.bindSum==='1') return;
      el.addEventListener('focus',()=>{
        const raw = el.dataset.raw ?? parse(el.value);
        if(!isNaN(raw)) el.value=Number(raw).toFixed(2);
      });
      el.addEventListener('blur',()=>{
        const raw=parse(el.value);
        if(isNaN(raw)){ el.value=''; delete el.dataset.raw; return; }
        el.dataset.raw=raw; el.value=fmt(raw);
      });
      el.dataset.bindSum='1';
      if(el.value) el.dispatchEvent(new Event('blur'));
    };
    const bindInside=node=>node.querySelectorAll('.inputSUM').forEach(bind);
    bindInside();

    const orig=createOrderElement;
    window.createOrderElement=(...args)=>{
      const html=orig(...args);
      setTimeout(()=>bindInside(ordersContainer),0);
      return html;
    };
  })();

  /*----------------------------------------------------------
    5. Загрузка существующих заказов
  ----------------------------------------------------------*/
  loadExistingOrders();
  async function loadExistingOrders(){
    const units = await unitsPromise;
    const { data:orders,error } = await supabase
      .from('orders')
      .select('*')
      .eq('user_key',USER_KEY)
      .order('created_at',{ascending:false});
    if(error){ console.error(error); return; }
    if(!orders?.length) return;

    orders.forEach(o=>{
      enrichCalculated(o, units);
      ordersContainer.insertAdjacentHTML('beforeend', createOrderElement(o));
      orderCnt+=1; orderSum+= num(o.field2);
      if(o.url){
        ordersContainer.lastElementChild.querySelector('.spec-icon')
          .addEventListener('click',()=>window.open(o.url,'_blank'));
      }
    });
    redrawStats();
  }

  /*----------------------------------------------------------
    6. Создание новой позиции
  ----------------------------------------------------------*/
  const createOrderBtn=document.getElementById('create-order');
  if(createOrderBtn){
    createOrderBtn.addEventListener('click', async ()=>{
      const form=document.querySelector('#modal1-container .modal-top .modalBLOCK');
      if(!form) return;
      const inp=form.querySelectorAll('.modalRow input');
      const units=await unitsPromise;
      const orderData={
        user_key:USER_KEY,
        orderCode:inp[0].value.trim(),
        name:inp[1].value.trim(),
        url:inp[2].value.trim(),
        supplier:inp[3].value.trim(),
        modification:inp[4].value.trim(),
        field1:inp[5].value.trim(),
        field2:inp[6].value.trim(),
        status:'заказано'
      };
      if(!orderData.orderCode||!orderData.name){
        alert('Заполните обязательные поля'); return;
      }
      enrichCalculated(orderData, units);           // добавляем вычисляемые поля
      try{
        const { base_unit, baseQty, priceBase, total, qtySel, priceSel, multMod, ...dbData } = orderData;
        await supabase.from('orders').insert([dbData]);

        ordersContainer.insertAdjacentHTML('afterbegin', createOrderElement(orderData));
        const el=ordersContainer.firstElementChild;
        el.classList.add('appear'); requestAnimationFrame(()=>el.classList.remove('appear'));

        orderCnt+=1; orderSum+= num(orderData.field2); redrawStats();
        if(orderData.url){
          el.querySelector('.spec-icon')
             .addEventListener('click',()=>window.open(orderData.url,'_blank'));
        }
        clearForm(); updateActionButtons();
      }catch(err){ alert('Ошибка: '+err.message); console.error(err); }
    });
  }

  /*----------------------------------------------------------
    7. Action‑buttons «переместить / удалить»
  ----------------------------------------------------------*/
  const actionRow=document.querySelector('#modal1-container .action-buttons');
  const updateActionButtons=()=>{
    const chk=ordersContainer.querySelector('input[type="checkbox"]:checked');
    actionRow.classList.toggle('visible',!!chk);
  };
  ordersContainer.addEventListener('change',e=>{
    if(e.target.matches('input[type="checkbox"]')) updateActionButtons();
  });
  updateActionButtons();

  document.getElementById('move-warehouse')
    ?.addEventListener('click',()=>console.log('Перемещение на склад'));
  document.getElementById('delete-selected')
    ?.addEventListener('click',()=>console.log('Удаление выбранного'));

  /*----------------------------------------------------------
    8. Вспомогательные функции
  ----------------------------------------------------------*/
  function clearForm(){
    const form=document.querySelector('#modal1-container .modal-top .modalBLOCK');
    if(!form) return;
    form.querySelectorAll('input').forEach(i=>{ i.value=''; delete i.dataset.raw; });
    form.querySelector('.select-input')?.value='';
  }

  function enrichCalculated(obj, units){
    obj.base_unit = getBaseUnit(obj.modification, units);
    obj.qtySel    = Number(obj.field1||0);
    obj.multMod   = getMultiplier(obj.modification, units);
    obj.priceSel  = parseFloatSafe(obj.field2);
    obj.baseQty   = obj.qtySel * obj.multMod;
    obj.priceBase = obj.multMod ? obj.priceSel / obj.multMod : 0;
    obj.total     = obj.priceBase * obj.multMod;
  }
}

/*----------------------------------------------------------
  Шаблон одного блока заказа
----------------------------------------------------------*/
function createOrderElement(o){
  return `
  <div class="modalBLOCK">
    <label>
      <input type="checkbox" class="input">
      <span class="custom-checkbox" style="margin-top:5px;margin-left:-8px;"></span>
    </label>

    <div class="modalRow">
      <input class="inputT"  style="width:130px;" placeholder="RIV-0881" value="${o.orderCode||''}" readonly/>
      <input class="input"   style="width:340px;" placeholder="наименование" value="${o.name||''}" readonly/>
      <input class="input"   style="width:150px;" placeholder="статус" value="заказано" readonly/>
      <span  class="spec-icon" style="margin-left:30px;" data-url="${o.url||''}">
        <i class="material-symbols-outlined">captive_portal</i>
      </span>
      <input class="inputT"  style="width:270px;" placeholder="поставщик" value="${o.supplier||''}" readonly/>
      <input class="input"   style="width:90px;margin-left:30px;" placeholder="изм." value="${o.modification||''}" readonly/>
      <input class="inputSUM" style="width:86px;" placeholder="000 000" value="${fmtNum(o.qtySel)}" readonly/>
      <input class="inputSUM"                  placeholder="000 000 000" value="${fmtNum(o.priceSel)}" readonly/>
    </div>

    <div class="modalRow" style="margin-left:30px;">
      <input class="input"    style="width:90px;" placeholder="изм." value="${o.base_unit||''}" readonly/>
      <input class="inputSUM" style="width:86px;" placeholder="000 000" value="${fmtNum(o.baseQty)}" readonly/>
      <input class="inputSUM"                  placeholder="000 000 000" value="${fmtNum(o.priceBase)}" readonly/>
      <input class="inputSUM"                  placeholder="000 000 000" value="${fmtNum(o.total)}" readonly/>
    </div>
  </div>`;
}
</script>
